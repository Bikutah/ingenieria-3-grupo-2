# .github/workflows/ci-pytest.yml
name: CI - PyTest (monorepo)

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    paths:
      - 'backend/**'
      - '.github/workflows/ci-pytest.yml'

permissions:
  contents: read

jobs:
  discover-apis:
    name: Discover APIs (backend/)
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.mk-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4
      - id: mk-matrix
        shell: bash
        run: |
          python - <<'PY' > matrix.json
          import os, json

          base_dir = "backend"
          apis = set()

          for root, dirs, files in os.walk(base_dir):
              # filtrar dirs: nada oculto, sin __pycache__ ni .github
              dirs[:] = [d for d in dirs if not d.startswith('.')
                                       and d != '__pycache__'
                                       and d != '.github']

              has_tests = 'tests' in dirs
              has_meta  = any(f in files for f in ('pytest.ini','pyproject.toml','requirements.txt'))

              # evitar tomar el propio base_dir si no es un proyecto en sí
              if root != base_dir and (has_tests or has_meta):
                  rel = os.path.relpath(root, '.')  # p.ej. backend/mi-api
                  apis.add(rel)

          print(json.dumps({"api": sorted(apis)}))
          PY
          echo "matrix=$(cat matrix.json)" >> "$GITHUB_OUTPUT"
          echo "Discovered matrix:"; cat matrix.json

  pytest:
    name: pytest (${{ matrix.api }})
    needs: discover-apis
    if: ${{ toJson(fromJson(needs.discover-apis.outputs.matrix).api) != '[]' }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.discover-apis.outputs.matrix) }}
    env:
      # usa una DB local por API; si tu app lee DATABASE_URL, esto evita el ValidationError
      DATABASE_URL: sqlite:///./test.db
      PYTEST_ADDOPTS: -q
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: |
            ${{ matrix.api }}/requirements.txt
            ${{ matrix.api }}/pyproject.toml

      - name: Install deps
        working-directory: ${{ matrix.api }}
        shell: bash
        run: |
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f pyproject.toml ]; then pip install .; fi
          pip install pytest

      - name: Run pytest
        working-directory: ${{ matrix.api }}
        run: pytest

  gate:
    name: ✅ All PyTests passed
    needs: pytest
    runs-on: ubuntu-latest
    if: ${{ always() }}
    steps:
      - name: Check matrix results
        run: |
          if [ "${{ needs.pytest.result }}" != "success" ]; then
            echo "Some API tests failed"; exit 1
          fi
          echo "All matrix jobs passed"
